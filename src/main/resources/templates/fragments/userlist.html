<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<body>
<div th:if="${!users.isEmpty()}" th:fragment="auserlist">
    <script>
        function setVerdict(user, verdict) {
            $.post({
                url: '/cp/verdict',
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify({
                    id: user,
                    verdict: verdict
                }),
                success: function (data) {
                    $('#user-row-container-' + user).remove();
                }
            });

        }

        function syncVerdict(user) {
            $.post({
                url: '/cp/sync-verdict',
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify({
                    id: user
                }),
                success: function (data) {
                    alert("syncVerdict: " + JSON.stringify(data));
                    //TODO: Тут может быть ошибка, нельзя просто-так удалять элемент
                    // $('#user-row-container-' + user).remove();
                }
            });
        }

    </script>
    <div th:replace="~{fragments/paging::pagingcontrol}"></div>
    <!--@thymesVar id="adminViewDTO" type="test.view.AdminViewDTO"-->
    <!--/*@thymesVar id="users" type="java.util.List<ru.gotinder.crawler.persistence.dto.CrawlerDataDTO>"*/-->
    <div class="container-fluid" th:each="u : ${users}">
        <!--/* Workaround for bug https://youtrack.jetbrains.com/issue/IDEA-132738 -->
        <!--@thymesVar id="u" type="ru.gotinder.crawler.persistence.dto.CrawlerDataDTO"-->
        <!--*/-->
        <div class="row" th:id="${'user-row-container-' + u.getId()}">
            <div class="col-md-3">
                <div>
                    <a
                            th:href="@{'/user/'+${u.getId()}}"
                            th:text="${u.getName() + '  ' + (T(java.time.LocalDateTime).now().getYear() - u.getBirthday().getYear())}"
                            th:classappend="
                        ${
                            (u.getVerdict() == T(ru.gotinder.crawler.persistence.dto.VerdictEnum).UNDEFINED ? 'undefined-verdict': '') +
                            (u.getVerdict() == T(ru.gotinder.crawler.persistence.dto.VerdictEnum).SUPERLIKE ? 'superliked' : '') +
                            (u.getVerdict() == T(ru.gotinder.crawler.persistence.dto.VerdictEnum).LIKE ? 'liked' : '') +
                            (u.getVerdict() == T(ru.gotinder.crawler.persistence.dto.VerdictEnum).PASS ? 'disliked' : '')
                        }">
                    </a>
                </div>
                <img th:src="${u.getPhoto().get(0)}" style="max-height: 160px; max-width: 200px;">
                <div style="font-size: 32px; font-weight: bold" th:text="${u.getRating()}">
                </div>
                <div>
                    <span>
                        <img src="/img/compass.png" alt="dst"/>
                        <span th:text="${u.getDistance()}"></span>
                    </span>
                    <span>
                         <img src="/img/abacus.png" alt="recs-duplicate"/>
                        <span th:text="${u.getRecsDuplicateCount()}"></span>
                    </span>
                </div>
                <div>
                    <img
                            th:data-user-id="${u.getId()}"
                            th:data-verdict="${T(ru.gotinder.crawler.persistence.dto.VerdictEnum).LIKE.toString()}"
                            onclick="setVerdict(this.getAttribute('data-user-id'),this.getAttribute('data-verdict'))"
                            src="/img/like.png"
                            class="clickable-element"
                            alt="like"/>

                    <img
                            th:data-user-id="${u.getId()}"
                            th:data-verdict="${T(ru.gotinder.crawler.persistence.dto.VerdictEnum).PASS.toString()}"
                            onclick="setVerdict(this.getAttribute('data-user-id'),this.getAttribute('data-verdict'))"
                            src="/img/dislike.png"
                            class="clickable-element"
                            alt="like"/>

                    <img
                            th:data-user-id="${u.getId()}"
                            th:data-verdict="${T(ru.gotinder.crawler.persistence.dto.VerdictEnum).SUPERLIKE.toString()}"
                            onclick="setVerdict(this.getAttribute('data-user-id'),this.getAttribute('data-verdict'))"
                            src="/img/superlike.png"
                            class="clickable-element"
                            alt="like"/>

                    <img th:if="${u.getVerdict() != T(ru.gotinder.crawler.persistence.dto.VerdictEnum).UNDEFINED}"
                         th:href="@{/cp/sync-verdict(id=${u.getId()})}"
                         th:data-user-id="${u.getId()}"
                         th:title="'Синхронизировать результат' + '(' + ${u.getVerdict()} + ')'"

                         onclick="syncVerdict(this.getAttribute('data-user-id'))"
                         src="/img/sync.png"
                         class="clickable-element"
                         data-toggle="tooltip"
                         data-placement="top"
                    >
                </div>
            </div>
            <div class="col-md-9">
                <span th:text="${u.getBio()}"></span>
                <details>
                    <summary>More photos</summary>
                    <div th:each="photo : ${u.getPhoto()}">
                        <img th:src="${photo}" style="max-height: 600px; max-width: 400px;">
                    </div>
                </details>
            </div>
        </div>
        <hr>
    </div>

    <div th:replace="~{fragments/paging::pagingcontrol}"></div>
</div>

<div th:unless="${!users.isEmpty()}" th:fragment="auserlist">
    Нет данных
</div>

</body>
</html>